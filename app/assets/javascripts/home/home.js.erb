/*global angular*/
/*global $*/

angular.module('ErikGibbons.Home', [
  'ui.router',
  'templates',
  'ngMaterial',
  'ngMdIcons',
  'ui.bootstrap',
  'ngSanitize',
  'ngParallax',
])

.config(['$stateProvider', function($stateProvider){
  $stateProvider
    .state('erikgibbons.home', {
      url: '/',
      views: {
        'main@': { // target the 'main' ng-view directive
          controller:  'HomeCtrl as homeCtrl',
          templateUrl: 'home/home.tmpl.html'
        }
      }
    })
  }
])

// .config(['ngImageGalleryOptsProvider', function(ngImageGalleryOptsProvider){
// 	ngImageGalleryOptsProvider.setOpts({
// 		thumbnails  	:   false,
// 		thumbSize		  : 	80,
// 		inline      	:   false,
// 		bubbles     	:   true,
// 		bubbleSize		: 	20,
// 		imgBubbles  	:   false,
// 		bgClose     	:   false,
// 		piracy 			  : 	false,
// 		imgAnim 	  	: 	'fadeup',
// 	});
// }])


.controller('HomeCtrl', ['$q', '$http', '$window', '$log', '$location', '$state', '$filter', '$timeout', function($q, $http, $window, $log, $location, $state, $filter, $timeout, $document){
  var homeCtrl = this;
  homeCtrl.setArrays = setArrays;
  homeCtrl.selectAll = selectAll;
  homeCtrl.gambarizeSetup = gambarizeSetup;
  homeCtrl.gambarizeReload = gambarizeReload;
  homeCtrl.allSkillsSelected = true;
  homeCtrl.galleryIndex = 0;
  homeCtrl.toggleSkill = toggleSkill;
  homeCtrl.opts = {
    history: false,
    index: 0
  };
  homeCtrl.projects = [
    {'name':'IPR Dominator', 'skills':['html', 'css', 'api', 'async', 'ror', 'js', 'jq', 'sql', 'io', 'alerts', 'stack', 'solr', 'charts', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Strain PLLC Time and Billing', 'skills':['html', 'css', 'async', 'ror', 'js', 'jq', 'sql', 'charts', 'io', 'stack', 'regex'], 'images':[{url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'x'},
    {'name':'iMessage Port', 'skills':['html', 'css', 'ror', 'sql', 'cron', 'io', 'alerts', 'stack', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Personal Movie Database', 'skills':['html', 'css', 'ror', 'api', 'js', 'jq', 'sql', 'angular', 'io', 'stack', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Stock Screener', 'skills':['html', 'css', 'stack', 'sql', 'async', 'ror', 'js', 'jq', 'io', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'RosterMod', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'async', 'js', 'jq', 'angular', 'charts', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Team Schedule API', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Grill Monitoring', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'regex', 'js', 'jq', 'charts'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Flight Check-In', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'async', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Patent Search', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'solr'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Oystermom', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'js', 'jq'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'},
    {'name':'Streak Automator', 'skills':['html', 'css', 'ror', 'js', 'phantom', 'regex', 'api'], 'images':[{url:"<%= image_url('placeholder.png') %>"}], 'url':'x'}
  ];
  homeCtrl.skills = [
    {'full':'HTML', 'short':'html','show':true},
    {'full':'CSS', 'short':'css','show':true},
    {'full':'Web Scraping and APIs', 'short':'api','show':true},
    {'full':'Multithreaded Asynchronous Jobs', 'short':'async','show':true},
    {'full':'Ruby on Rails', 'short':'ror','show':true},
    {'full':'Javascript', 'short':'js','show':true},
    {'full':'jQuery', 'short':'jq','show':true},
    {'full':'SQL', 'short':'sql','show':true},
    {'full':'CRON Jobs', 'short':'cron','show':true},
    {'full':'Angular', 'short':'angular','show':true},
    {'full':'Charts', 'short':'charts','show':true},
    {'full':'Import/Export Files', 'short':'io','show':true},
    {'full':'Alerts/Emails', 'short':'alerts','show':true},
    {'full':'Full Stack', 'short':'stack','show':true},
    {'full':'Websolr', 'short':'solr','show':true},
    {'full':'Regular Expressions', 'short':'regex','show':true},
    {'full':'PhantomJS', 'short':'phantom','show':true}
  ];

  function init() {
    homeCtrl.gambarizeSetup();

    homeCtrl.setArrays(true);
  } // end of init
  
  init();
  
  /*********************
  *  Private functions *
  * *******************/
  
  // Function to toggle shown skills
  function toggleSkill(changeSkill){
    var skill = $filter('filter')(homeCtrl.skills, function(v){
      return v['short'] == changeSkill;
    });
    skill[0]['show'] = !skill[0]['show'];
  }
  
  // Function to reset variables whenever checkbox is clicked
  function setArrays(initial = false){
    homeCtrl.activeSkillsArray = $filter('filter')(homeCtrl.skills, function(v){
      if(v['show']){
        return v
      }
    }).map(function(e){
      return e['short'];
    });
    
    // projects that include checked skills
    homeCtrl.showProj = $filter('filter')(homeCtrl.projects, function(v){
      return v['skills'].some(function(s){ 
        return homeCtrl.activeSkillsArray.includes(s)
      });
    });
    
    // if all skills are checked or unchecked, reflect that in allSkillsSelected
    if(homeCtrl.activeSkillsArray.length == homeCtrl.skills.length){
      homeCtrl.allSkillsSelected = true;
    }else{
      homeCtrl.allSkillsSelected = false
    }
    if(!initial && homeCtrl.showProj.length > 0){
      angular.element(document).ready(function(){
        homeCtrl.gambarizeReload();
      });
    }
  }
  
  function selectAll(){
    if(homeCtrl.allSkillsSelected == true){
      angular.forEach(homeCtrl.skills, function(v){
        v['show'] = false;
      });
    }else{
      angular.forEach(homeCtrl.skills, function(v){
        v['show'] = true;
      });
    }
    homeCtrl.setArrays();
  }
  
  function gambarizeSetup(){
    window.gambarize_instance='';
    
    function gambarizeInit(){
      gambarize_instance0 = new gambarize();
      gambarize_instance0.init({
        content: {
          source: 'a',
          selector: 'gmbz',
          loadInDiv: 'gallery1'
        }
      });
    }
    
    $(window).on('load', gambarizeInit);
  }
  
  function gambarizeReload(){
    console.log(homeCtrl.showProj.map(function(proj){
      return proj.name
    }));
    // Use evals to set dynamic variables so that new instances of gambarize can be created to avoid errors
    eval("gambarize_instance" + homeCtrl.galleryIndex.toString() + ".uninit();");
    eval("gambarize_instance" + homeCtrl.galleryIndex.toString() + " = '';");
    homeCtrl.galleryIndex++;
    eval("gambarize_instance" + homeCtrl.galleryIndex.toString() + " = new gambarize();");
    eval("gambarize_instance" + homeCtrl.galleryIndex.toString() + ".init({content: {source: 'a', selector: 'gmbz', loadInDiv: 'gallery1' } });");
  }
}]);