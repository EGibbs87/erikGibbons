/*global angular*/
/*global $*/

angular.module('ErikGibbons.Home', [
  'ui.router',
  'templates',
  'ngMaterial',
  'ngMdIcons',
  'ui.bootstrap',
  'ngSanitize',
  'ngParallax',
])

.config(['$stateProvider', function($stateProvider){
  $stateProvider
    .state('erikgibbons.home', {
      url: '/',
      views: {
        'main@': { // target the 'main' ng-view directive
          controller:  'HomeCtrl as homeCtrl',
          templateUrl: 'home/home.tmpl.html'
        }
      }
    })
  }
])

.controller('HomeCtrl', ['$q', '$http', '$window', '$log', '$location', '$state', '$filter', '$timeout', function($q, $http, $window, $log, $location, $state, $filter, $timeout, $document){
  var homeCtrl = this;
  homeCtrl.setArrays = setArrays;
  homeCtrl.setProj = setProj;
  // homeCtrl.selectAll = selectAll;
  homeCtrl.allSkillsSelected = true;
  homeCtrl.toggleSkill = toggleSkill;
  homeCtrl.projects = [
    {'name':'IPR Dominator', 'skills':['html', 'css', 'api', 'async', 'ror', 'js', 'jq', 'sql', 'io', 'alerts', 'stack', 'solr', 'charts', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://www.iprdominator.com'},
    {'name':'Strain PLLC Home', 'skills':['html', 'css', 'ror', 'js', 'jq', 'stack',], 'images':[{url:"<%= image_url('luca-bravo-2.jpg') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://www.strainpllc.com'},
    {'name':'Strain PLLC Time and Billing', 'skills':['html', 'css', 'async', 'ror', 'js', 'jq', 'sql', 'charts', 'io', 'stack', 'regex'], 'images':[{url:"<%= image_url('luca-bravo-2.jpg') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://time.strainpllc.com'},
    {'name':'iMessage Port', 'skills':['html', 'css', 'ror', 'sql', 'cron', 'io', 'alerts', 'stack', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'N/A'},
    {'name':'Personal Movie Database', 'skills':['html', 'css', 'ror', 'api', 'js', 'jq', 'sql', 'angular', 'io', 'stack', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://eg-movie-list.herokuapp.com'},
    {'name':'Stock Screener', 'skills':['html', 'css', 'stack', 'sql', 'async', 'ror', 'js', 'jq', 'io', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://cjg-stock-screener.herokuapp.com'},
    {'name':'RosterMod', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'async', 'js', 'jq', 'angular', 'charts', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'https://www.rostermod.com'},
    {'name':'Team Schedule API', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'rostermod.com/team_schedule_api.html'},
    {'name':'Grill Monitoring', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'regex', 'js', 'jq', 'charts'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://ss-grill.herokuapp.com'},
    {'name':'Flight Check-In', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'async', 'regex'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'N/A'},
    {'name':'Patent Search', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'api', 'solr'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'N/A'},
    {'name':'Oystermom', 'skills':['html', 'css', 'stack', 'sql', 'ror', 'js', 'jq'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'http://www.oystermom.com'},
    {'name':'Streak Automator', 'skills':['html', 'css', 'ror', 'js', 'phantom', 'regex', 'api'], 'images':[{url:"<%= image_url('placeholder.png') %>"}, {url:"<%= image_url('luca-bravo-2.jpg') %>"}], 'url':'N/A'}
  ];
  homeCtrl.activeProj = homeCtrl.projects[0];
  homeCtrl.skills = [
    {'full':'HTML', 'short':'html','show':true},
    {'full':'CSS', 'short':'css','show':false},
    {'full':'Ruby on Rails', 'short':'ror','show':false},
    {'full':'Full Stack', 'short':'stack','show':false},
    {'full':'SQL', 'short':'sql','show':false},
    {'full':'Javascript', 'short':'js','show':false},
    {'full':'jQuery', 'short':'jq','show':false},
    {'full':'Angular', 'short':'angular','show':false},
    {'full':'Charts', 'short':'charts','show':false},
    {'full':'PhantomJS', 'short':'phantom','show':false},
    {'full':'Web Scraping and APIs', 'short':'api','show':false},
    {'full':'Multithreaded Asynchronous Jobs', 'short':'async','show':false},
    {'full':'Regular Expressions', 'short':'regex','show':false},
    {'full':'Import/Export Files', 'short':'io','show':false},
    {'full':'Alerts/Emails', 'short':'alerts','show':false},
    {'full':'Websolr', 'short':'solr','show':false},
    {'full':'CRON Jobs', 'short':'cron','show':false}
  ];

  // BrowserDetect to identify Mac and Browser
  var BrowserDetect = {
    init: function () {
      this.browser = this.searchString(this.dataBrowser) || "An unknown browser";
      // this.version = this.searchVersion(navigator.userAgent)
      //   || this.searchVersion(navigator.appVersion)
      //   || "an unknown version";
      this.OS = this.searchString(this.dataOS) || "an unknown OS";
    },
    searchString: function (data) {
      for (var i=0; i<data.length; i++) {
        var dataString = data[i].string;
        var dataProp = data[i].prop;
        this.versionSearchString = data[i].versionSearch || data[i].identity;
        if (dataString) {
          if (dataString.indexOf(data[i].subString) != -1) {
            return data[i].identity;
          }
          else if (dataProp) {
            return data[i].identity;
          }   
        }
      }
    },
    // searchVersion: function (dataString) {
    //   var index = dataString.indexOf(this.versionSearchString);
    //   if (index == -1) return;
    //   return parseFloat(dataString.substring(index+this.versionSearchString.length+1));
    // },
    dataBrowser: [
      {
        string: navigator.userAgent,
        subString: "Chrome",
        identity: "Chrome"
      },
      {     
        string: navigator.userAgent,
        subString: "OmniWeb",
        versionSearch: "OmniWeb/",
        identity: "OmniWeb"
      },
      {
        string: navigator.vendor,
        subString: "Apple",
        identity: "Safari",
        versionSearch: "Version"
      },
      {
        prop: window.opera,
        identity: "Opera",
        versionSearch: "Version"
      },
      {
        string: navigator.vendor,
        subString: "iCab",
        identity: "iCab"
      },
      {
        string: navigator.vendor,
        subString: "KDE",
        identity: "Konqueror"
      },
      {
        string: navigator.userAgent,
        subString: "Firefox",
        identity: "Firefox"
      },
      {
        string: navigator.vendor,
        subString: "Camino",
        identity: "Camino"
      },
      {        // for newer Netscapes (6+)
        string: navigator.userAgent,
        subString: "Netscape",
        identity: "Netscape"
      },
      {
        string: navigator.userAgent,
        subString: "MSIE",
        identity: "Explorer",
        versionSearch: "MSIE"
      },
      {
        string: navigator.userAgent,
        subString: "Gecko",
        identity: "Mozilla",
        versionSearch: "rv"
      },
      {         // for older Netscapes (4-)
        string: navigator.userAgent,
        subString: "Mozilla",
        identity: "Netscape",
        versionSearch: "Mozilla"
      }
    ],
    dataOS : [
      {
        string: navigator.platform,
        subString: "Win",
        identity: "Windows"
      },
      {
        string: navigator.platform,
        subString: "Mac",
        identity: "Mac"
      },
      {
        string: navigator.userAgent,
        subString: "iPhone",
        identity: "iPhone/iPod"
      },
      {
        string: navigator.platform,
        subString: "Linux",
        identity: "Linux"
      } 
    ]
  };
  BrowserDetect.init();
  homeCtrl.os = BrowserDetect.OS;
  homeCtrl.browser = BrowserDetect.browser

  function init() {
    homeCtrl.setArrays(true);
  } // end of init
  
  init();
  
  /*********************
  *  Private functions *
  * *******************/
  
  // Function to toggle shown skills
  function toggleSkill(changeSkill, $event){
    var accumulate = false;
    var onCount = homeCtrl.skills.reduce(function(total, x){return x['show'] ? total + 1 : total}, 0)
    if(homeCtrl.os == "Mac"){
      if($event.metaKey){
        accumulate = true;
      }else{
        accumulate = false;
      }
    }else{
      if($event.ctrlKey){
        accumulate = true;
      }else{
        accumulate = false;
      }
    }
    if(accumulate){
      var switchSkill = $filter('filter')(homeCtrl.skills, function(v){
        return v['short'] == changeSkill;
      })[0];
      // Set change
      if(onCount > 1 || !switchSkill['show']){
        switchSkill['show'] = !switchSkill['show'];
      } 
    }else{
      var offSkills = $filter('filter')(homeCtrl.skills, function(v){
        return v['show']
      });
      var onSkill = $filter('filter')(homeCtrl.skills, function(v){
        return v['short'] == changeSkill;
      })[0];
      // Set changes
      angular.forEach(offSkills, function(v){
        v['show'] = false;
      });
      onSkill['show'] = true;
    }
  }
  
  // Function to reset variables whenever skill is toggled
  function setArrays(initial){
    homeCtrl.activeSkillsArray = $filter('filter')(homeCtrl.skills, function(v){
      if(v['show']){
        return v
      }
    }).map(function(e){
      return e['short'];
    });
    
    // projects that include checked skills
    homeCtrl.showProj = $filter('filter')(homeCtrl.projects, function(v){
      
      // filter by whether project includes each currently active skill
      includesAllSkills = homeCtrl.activeSkillsArray.map(function(s){
        return v['skills'].indexOf(s) >= 0
      }).reduce(function(t, e){ return t * e })
      
      // return array of projects that meet every criterion
      return includesAllSkills;
    });

    homeCtrl.showProjLength = (homeCtrl.showProj.length > 0);
    
    // if all skills are checked or unchecked, reflect that in allSkillsSelected
    if(homeCtrl.activeSkillsArray.length == homeCtrl.skills.length){
      homeCtrl.allSkillsSelected = true;
    }else{
      homeCtrl.allSkillsSelected = false
    }
  }
  
  // Function to set a project to show
  function setProj(proj){
    homeCtrl.activeProj = $filter('filter')(homeCtrl.projects, function(v){
      if(v['name'] == proj){
        return v
      }
    })[0]
  }
  
  // function selectAll(){
  //   if(homeCtrl.allSkillsSelected == true){
  //     angular.forEach(homeCtrl.skills, function(v){
  //       v['show'] = false;
  //     });
  //     // set HTML back to true
  //     homeCtrl.skills[0]['show'] = true;
  //   }else{
  //     angular.forEach(homeCtrl.skills, function(v){
  //       v['show'] = true;
  //     });
  //   }
  //   homeCtrl.setArrays();
  // }
}]);